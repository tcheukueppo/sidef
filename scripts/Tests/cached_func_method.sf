#!/usr/bin/ruby


func fib(n) is cached -> Num {
    n < 2 ? n : (fib(n-1) + fib(n-2));
};

say fib(120);


class Fib {
    method nth(n) is cached -> Num {
        n < 2 ? n : (self.nth(n-1) + self.nth(n-2));
    }
    method +(n) is cached -> Num {
        n < 2 ? n : (self+(n-1) + self+(n-2));
    }
}

var fib = Fib();
say fib.nth(120);
say fib+120;

do {
    # Tests for Block.cache and Block.uncache

    var arr = []

    func foo(n) { arr << n }
    func bar(n) { arr << n }

    foo.cache
    foo(42)
    foo(42)
    assert_eq(arr, [42])
    foo.uncache
    foo(42)
    assert_eq(arr, [42, 42])
    foo.uncache
    foo(42)
    assert_eq(arr, [42, 42, 42])
    bar.uncache
    bar(99)
    assert_eq(arr, [42, 42, 42, 99])
}
